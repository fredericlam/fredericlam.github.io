
<!DOCTYPE html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta name="viewport" content="width=device-width">
<meta name="description" content="Die Bevölkerungspyramide (Alterspyramide) des Statistischen Bundesamtes zeigt die Altersstruktur Deutschlands von 1950 bis 2060.">
<meta name="format-detection" content="telephone=no">
<title>13. koordinierte Bevölkerungsvorausberechnung</title>
<!--

	This borrows heavily from Mike Bostock's take on the population pyramid
	Many thanks and see http://bl.ocks.org/mbostock/4062085 for details
	
-->
</head>
<style>

body {
	font-family: Arial, sans-serif;
	margin: 0;
	padding: 0;
}

#wrapper {
	width: 1210px;
	height: 900px;
}

@media screen and (max-width: 700px) {
	
	#wrapper {
	width: 512px;
	height: 740px;
	}
}


#pageHeader {
	top: 20px;
	width: 1170px;
	padding-left: 40px;
	height: 50px;
	position: absolute;
/* help for touch devices and slider usability */
	-webkit-user-select: none;
	-moz-user-select: none;
	user-select: none;
}

#pageHeader h1 {
	padding-top: 5px;
	margin: 0;
	font-size: 18px;
	letter-spacing: -0.03em;
	float: left;
	color: #444;
}

#pageHeader img {
	right: 10px;
	position: absolute;
	border: 0;
}

h4 {
	font-size: 12px;
	font-weight: bold;
	margin-top: 12px;
	margin-bottom: 8px;
}

#easel {
	top: 80px;
	width: 710px;
	height: 674px;
	position: absolute;
/* help for touch devices and slider usability */
	-webkit-user-select: none;
	-moz-user-select: none;
	user-select: none;
}

#easel p {
	padding-top: 200px;
	padding-left: 100px; 
}

#easel .spinner {
	font-size: 24px;
}

#easel .fineprint {
	font-size: 14px;
}

#dashBoard {
	top: 80px;
	left: 810px;
	height: 670px;
	width: 400px;
	position: absolute;
/* help for touch devices and slider usability */
	-webkit-user-select: none;
	-moz-user-select: none;
	user-select: none;
}

#variantBox {
	font-size: 13px;
	top: 36px;
	left: 60px;
	position: absolute;
}

#variantBox .radioButton {
	font-size: 12px;
	margin-top: 4px;
	margin-bottom: 2px;
	margin-left: 2px;
}

#variantBox input {
	margin-right: 7px;
}

#assumptions {
	font-size: 12px;
	top: 178px;
	left: 60px;
	position: absolute;
}

#assumptions ul {
	margin-top: 6px;
	margin-bottom: 0;
	padding-left: 24px;
} 

#assumptions li {
	line-height: 140%;
	padding-bottom: 6px;
} 

#copyright {
	width: 1210px;
	top: 780px;
	position: absolute;
}

#copyright p {
	font-size: 11px;
	text-align: right;
	margin: 0px;
}

#data {
	font-size: 12px;
	position: absolute;
	top: 370px;
	left: 66px;
}

table { 
	text-align: right; 
	border-collapse: collapse;
}

#tAge {
	width: 78px;
	text-align: left;
}

#tMill {
	width: 96px;
}

#tRatio {
	width: 90px;
}


td { 
	padding-top: 7px;
	padding-bottom: 5px;
}

.above {
	border-top : 1px solid black;
}

.middle {
	border-top : 1px solid black;
	border-bottom: 1px solid black;
}

.ageLimitTxt {
	border-right: 8px solid white;
}

.ageLimitTxt {
	padding-right: 16px;
}

#footer {
	width: 100%;
	bottom: 2px;
	position: absolute;
}

#footer p {
	margin: 0;
	font-size: 11px;
}

.embed {
	color: blue;
	left: 65px;
	float: left;
	position: relative;
}

.centerGraph {
	text-align: center;
	left: 290px;
}

a {text-decoration: none; color: #0f478c}
a:hover { cursor:pointer; text-decoration: none; background-color: #ddd;}

.flushRight {
	right: 15px;
	float: right;
	position: relative;
}

#ageLimitControl {
	top: 590px;
	left: 66px;
	position: absolute;
}

#ageLimitControl p {
	font-size: 12px;
	margin-top: 6px;
	margin-bottom: 6px;
}

#legend {
	top: 65px;
	left: 85px;
	position: absolute;
}

#legend button {
	pointer-events: none;
	position: absolute;
	top: 0px;
	padding-left: 3px;
	padding-right: 3px;
	font-size: 9px;
}

.mini {
	fill: #444;
	pointer-events: none;
}

.Year {
	font-weight: bold;
	font-size: 11px;
}

.Variant {
	font-size: 10px;
}

svg {
  overflow: hidden;
  font: 10px Arial, sans-serif;
  text-anchor: middle;
}

.x.axis path {
  display: none;
}

.x.axis line {
  stroke: #fff;
/*   stroke-opacity: .2; */
  stroke-opacity: .3;
  shape-rendering: crispEdges;
}

.xAxisLabel {
  font-size: 11px;
  fill: #000;	
}

.title {
  font-size: 36px;
  letter-spacing: -2px;
  font-weight: bold;
  fill: #999;
}

.subtitle {
  font-size: 13px;
  font-weight: normal;
  fill: #333;
}

.birthyear {
  font-size: 8px;
  fill: #fff;
/*   fill: none; */
}

.hoverBirthYear {
	pointer-events: none;
	font-size: 12px;
	font-weight: bold;
	fill: #fff;
	text-shadow: 1px 1px 2px #333;
}

.age {
  fill: #444;
  font-weight: bold;
  font-size: 12px;
}

.ageLimit {
	color: #444;
	font-family: Arial, sans-serif;
	font-size: 12px;
	font-weight: bold;
	position: absolute;
	left: -7px;
/* 	padding-top: 2px; */
	z-index: 10;
	pointer-events: none;
}

.symmetry {
  pointer-events: none;
  fill-opacity: .25;
  fill: white;
}

.envelopeCurve {
	fill: none;
	stroke: lime;
	stroke-width: 1.5px;
	stroke-linejoin: bevel;
	pointer-events: none;
}

.miniCurve {
	stroke-width: 20px;
	pointer-events: none;
}

.swoosh {
	stroke: #e21616;
	stroke-width: 5;
	fill: none;
}

.xl {
/* 	these elements will only be used in the XL size */
}

.nick {
	font-weight: normal;
	padding-left: 6px;
}


/* 
	slider styles from external D3 slider file merged here
*/

#sliderHolder {
/* help for touch devices and slider usability */
	-webkit-user-select: none;
	-moz-user-select: none;
	user-select: none;

	height: 480px;
	left: 722px;
	top: 160px;
	position: absolute;
}

.tick text {
	-moz-user-select: none;
}

.d3-slider {
    position: relative;
    font-family: Arial,sans-serif;
    font-size: 1.1em;
    border: 1px solid #aaaaaa;
    z-index: 2;
}

.d3-slider-range-vertical {
  background: none;
  left:0px;
  right:0px;
  position: absolute;
  top:0;
}

.d3-slider-vertical {
    width: .8em;
    height: 100px;
}      

.d3-slider-handle {
    position: absolute;
    width: 1.2em;
    height: 1.2em;
    border: 1px solid #d3d3d3;
    border-radius: 4px;
    background: #eee;
    background: linear-gradient(to bottom, #eee 0%, #ddd 100%);
    z-index: 3;
}

.d3-slider-handle:hover {
    border: 1px solid #888;
}

#ageSliderHolder {
	display: none;
	border: 0;
	position: absolute;
}

#ageSliderHolder .d3-slider-range-vertical {
	background: none;
}

#ageSliderHolder .d3-slider-handle {
	width: 130px;
    margin-bottom: -.35em;      
	height: 9px;
	left: -65px;
	cursor: row-resize;
    background: linear-gradient(to bottom, #fff 0%, #eee 100%);
}

.d3-slider-axis {
    position: relative;
    z-index: 1;    
}

.d3-slider-axis-right {
    left: .8em;
	pointer-events: none;
}

.d3-slider-axis path {
    stroke-width: 0;
    fill: none;
}

.d3-slider-axis line {
    fill: none;
    stroke: #aaa;
    shape-rendering: crispEdges;
}

.d3-slider-axis text {
    font-size: 11px;
}

.d3-slider-vertical .d3-slider-handle {
    left: -.25em;
    margin-left: 0;
    margin-bottom: -.6em;      
}

/* end slider styles */


@media print {
	
	.noPrint, .symmetry, #ageSliderHolder, .d3-slider-handle { display:none;}

	.x.axis line, .males, .females {
		stroke: #fff;
		stroke-opacity: 1;
		stroke-width: 0.2pt;
		shape-rendering: crispEdges;
	}

	a {color: #000;}

}

/* loading spinner */
.spinner {
  -webkit-animation: moveMe 10.0s infinite linear;
  animation: moveMe 10.0s infinite linear;
}

@-webkit-keyframes moveMe {
  0% { -webkit-transform: translate(0) }
  50% { -webkit-transform: translate(300px) }
  100% { -webkit-transform: translate(0) }
}
@keyframes moveMe {
  0% { transform: translate(0) }
  50% { transform: translate(300px) }
  100% { transform: translate(0) }
}

</style>


<body onload="hookEvent('easel', 'mousewheel', MouseWheel)">

<div id="wrapper">

<div id="pageHeader">
	
	<h1 id="headline">Pyramid des ages</h1>
			
</div>

<div id="easel" ondblclick="resetClicked()"
				ontouchstart="touchStart(event);"
				ontouchmove="touchMove(event);"
				ontouchend="touchEnd(event);" onmouseover="removeCircles()">
					
	<p class="spinner hourglass">… Daten werden geladen …</p>

	<p class="fineprint hourglass">Sollte dieser Hinweis nicht nach wenigen Sekunden verschwinden, <br> 
									dann prüfen Sie bitte, ob JavaScript aktiviert ist und <br> 
									Sie einen modernen Browser verwenden</p>

	<!--  click event for that button is added to the attached SVG where the mini outline goes 
		see function outline()
	-->
	<div id="legend" class="xl"><button id="makeOutline" class="noPrint" onclick="outline(year, tmpVariant)"> </button></div>

</div>

<div id="sliderHolder" class="xl noPrint"> </div>

<div id="dashBoard">
	
	<div class="futureMeta">

	<div id="variantBox" class="xl">

		<h4 id="variantNick"></h4>

		<p class="radioButton"><input type="radio" name="variantMenu" id="v1" value="v1" onchange="changeVariant(this.value)"><span id="v1name"></span></p>
		<p class="radioButton"><input type="radio" name="variantMenu" id="v2" value="v2" onchange="changeVariant(this.value)"><span id="v2name"></span></p>
		<p class="radioButton"><input type="radio" name="variantMenu" id="v3" value="v3" onchange="changeVariant(this.value)"><span id="v3name"></span></p>
		<p class="radioButton"><input type="radio" name="variantMenu" id="v6" value="v6" onchange="changeVariant(this.value)"><span id="v6name"></span></p>
		 
	</div>
	
	<div id="assumptions">

		<h4 id="asmpH4"><span id="assumptionsHead"></span> <span id="assumptionsHeadx" class="nick"></span></h4>
		
		<ul id="assumptionList">
		</ul>

	</div>

	</div>	<!-- end of what will be displayed in years >= beginProjection -->
	
	<div id="data">

	    <table>

			<tr >
	    		<td id="tAge"></td>
	    		<td id="tMill"></td>
	    		<td id="tRatio"></td>
			</tr>
			<tr class="above">
	    		<td class="ageLimitTxt" id="txUp"></td>
	    		<td id="oldAbs"></td>
	    		<td id="oldPerc"></td>
			</tr>
			<tr>
	    		<td class="ageLimitTxt" id="txMed"></td>
	    		<td id="mediumAbs"></td>
	    		<td id="mediumPerc"></td>
			</tr>
			<tr>
	    		<td class="ageLimitTxt" id="txLow"></td>
	    		<td id="youngAbs"></td>
	    		<td id="youngPerc"></td>
			</tr>
			<tr class="above">
	    		<td id="tTotal" style="text-align: left;"></td>
	    		<td id="totals"></td>
	    		<td >100%</td>
			</tr>			

	    </table>
		<p class="xl">&nbsp;</p>
		<p id="altQ" class="xl"></p>

	</div>
	
	<div id="ageLimitControl" class="noPrint xl" >
			
		<p><span id="ageGroupsTxt"></span> <button id="ageLimiter" onclick="toggleAgeLimits()"> </button></p> 

	</div>

	<div id="footer" class="noPrint">
				
		<p class="embed xl"><a href="bev13te_v1236.csv"><span id="downloadInfo"></span></a></p> 
		<p class="flushRight"><a target="_blank" title="Öffnet Materialien der Pressekonferenz in einem neuen Fenster" href="https://www.destatis.de/DE/PresseService/Presse/Pressekonferenzen/2015/bevoelkerung/bevoelkerung_2015_pk.html"><span id="furtherInfo"></span></a> 
		<!--  --></p>
		
	</div>

</div> <!-- end dashboard -->

	<div id="copyright">

		<p class="embed xl centerGraph" onclick="embed()"><a href="#" title="embed"><spand id="embedLink"></spand>&nbsp; &lt; / &gt;</a></p> 
		
		<p class="flushRight">© <a target="_blank" title="Öffnet das Impressum des Statistischen Bundesamtes in einem neuen Fenster" href="https://www.destatis.de/DE/Meta/Impressum/Impressum.html">
			Statistisches Bundesamt 2015</a></p>
	</div>

</div> <!-- end wrapper -->
</body>


<script src="js/d3.min.js"></script>
<!-- 
	D3 slider thanks to 
	http://thematicmapping.org/playground/d3/d3.slider/
-->
<script src="js/d3.slider.js"></script>
<script>


// 
//  LAYOUT
//
var margin = {top: 13, right: 0, bottom: 35, left: 20},
    centerPadding = 30, 
    // width refers to one half pyramid
    width = 340 - margin.left - margin.right,
    height = 670 - margin.top - margin.bottom,
    barHeight = Math.floor(height / 100);	// 100 agebands

//
// GLOBALS
//
var datacsv, data = [], title, analyse, animate, animState = false, fixState = false, 
	initialOutline = false, ioYear, ioVariant, ageState = false, firstRun = false,
	tmpMcolor, tmpFcolor, birthyear, uiHolder, clickBirthYear =0, currSize,
	pastMcolor = "#336", pastFcolor = "#606", futureMcolor = "#369", futureFcolor = "#906", 
	highlight = "#fc3", oldColor = "#fa3", mediumColor = "#382", youngColor = "#888",
	locale;

var state = {
		year : { hsh : 'y',
				default: 2014
		},
		agelimits : { hsh : 'a',
				default: "20,65"
		},
		variant : { hsh : 'v',
				default: 1
		},
		outline : { hsh : 'o'},
		language : { hsh : 'l',
				default: 'de'
		},
		size : { hsh : 's',
				default: 'xl'
		},
		agegroups : { hsh : 'g',
				default: false
		},
		birthyear : { hsh : 'b',
					default: 0
		}
}


//
// Descriptive Texts
//

// Main Headline Projection for years >= beginProjection
var head = {
	de: "13. koordinierte Bevölkerungsvoraus­berechnung für Deutschland",
	en: "13th coordinated Population Projection for Germany",
	fr: "13ème Projection coordonnée de la population de l’Allemagne",
	es: "13. Proyección coordinada de la población de Alemania",
	ru: "13-й координированный прогноз населения Германии"
}

// Headline for years < beginProjection
var headPast = {
	de: "Bevölkerung in Deutschland",
	en: "Population in Germany",
	fr: "La population de l’Allemagne",
	es: "La población en Alemania",
	ru: "Население Германии"
}

// X-axis labels for men and women
var xMen = {
	de: "Männer (in Tausend)",
	en: "Men (thousand)",
	fr: "Hommes (Milliers)",
	es: "Varones (Miles)",
	ru: "Мужчины (тысяч)"
}

var xWomen = {
	de: "Frauen (in Tausend)",
	en: "Women (thousand)",
	fr: "Femmes (Milliers)",
	es: "Mujeres (Miles)",
	ru: "Женщины (тысяч)"
}


var ageStructure = {
	de: "Altersaufbau",
	en: "Age Structure",
	fr: "Pyramide des âges",
	es: "Estructura de edad",
	ru: "Возрастная структура"
}

var makeOutlineVerb = {
	de: "Fixieren",
	en: "Lock",
	fr: "fixer",
	es: "congelar",
	ru: "Запомнить"
}


var Variant = {
	de: "Varianten",
	en: "Variants",
	fr: "Variantes",
	es: "Escenarios",
	ru: "Варианты"
}

// var variantNames
var v1name = {
	de: "Kontinuität bei schwächerer Zuwanderung",
	en: "Continued trend based on lower immigration",
	fr: "Continuité avec immigration relativement faible",
	es: "Continuidad con menos pronunciada inmigración",
	ru: "Последовательное развитие, пониженная миграция"
}

var v2name = {
	de: "Kontinuität bei stärkerer Zuwanderung",
	en: "Continued trend based on higher immigration",
	fr: "Continuité avec immigration relativement forte",
	es: "Continuidad con mas pronunciada inmigración",
	ru: "Последовательное развитие, повышенная миграция"
}

var v3name = {
	de: "Relativ alte  Bevölkerung",
	en: "Relatively old population",
	fr: "Population relativement agée",
	es: "Población relativamente envejecida",
	ru: "Относительно старое население"
}

var v6name = {
	de: "Relativ junge Bevölkerung",
	en: "Relatively young population",
	fr: "Population relativement jeune",
	es: "Población relativamente jóven",
	ru: "Относительно молодое население"
}


// Variant Short Name
// will be used under outline legend
var shortVariant = {
	v0: "",
	v1: "G1-L1-W1",
	v2: "G1-L1-W2",
	v3: "G1-L2-W1", // alt		
	v6: "G2-L1-W2"	// jung
}


var Assumptions = {
	de: "Annahmen",
	en: "Assumptions",
	fr: "Hypothèses",
	es: "Supuestos",
	ru: "Предположения"
}


var assumptionDetails = {
	
	de: {
		v0: "",
		v1: "<li>Geburtenhäufigkeit<br>1,4 Kinder je Frau</li><li>Lebenserwartung bei Geburt 2060<br>84,8 Jahre für Jungen<br>88,8 Jahre für Mädchen</li><li>Wanderungssaldo (ab 2021)<br>+ 100 000 Personen</li>",
		v2: "<li>Geburtenhäufigkeit<br>1,4 Kinder je Frau</li><li>Lebenserwartung bei Geburt 2060<br>84,8 Jahre für Jungen<br>88,8 Jahre für Mädchen</li><li>Wanderungssaldo (ab 2021)<br>+ 200 000 Personen</li>",
		v3: "<li>Geburtenhäufigkeit<br>1,4 Kinder je Frau</li><li>Lebenserwartung bei Geburt 2060<br>86,7 Jahre für Jungen<br>90,4 Jahre für Mädchen</li><li>Wanderungssaldo (ab 2021)<br>+ 100 000 Personen</li>",		
		v6: "<li>Geburtenhäufigkeit<br>1,6 Kinder je Frau</li><li>Lebenserwartung bei Geburt 2060<br>84,8 Jahre für Jungen<br>88,8 Jahre für Mädchen</li><li>Wanderungssaldo (ab 2021)<br>+ 200 000 Personen</li>"
	},
	en: {
		v0: "",
		v1: "<li>Birth rate<br>1.4 children per woman</li><li>Life expectancy of a newborn in 2060<br>84.8 years for boys<br>88.8 years for girls</li><li>Net migration (from 2021)<br>+ 100,000 persons</li>",
		v2: "<li>Birth rate<br>1.4 children per woman</li><li>Life expectancy of a newborn in 2060<br>84.8 years for boys<br>88.8 years for girls</li><li>Net migration (from 2021)<br>+ 200,000 persons</li>",
		v3: "<li>Birth rate<br>1.4 children per woman</li><li>Life expectancy of a newborn in 2060<br>86.7 years for boys<br>90.4 years for girls</li><li>Net migration (from 2021)<br>+ 100,000 persons</li>",
		v6: "<li>Birth rate<br>1.6 children per woman</li><li>Life expectancy of a newborn in 2060<br>84.8 years for boys<br>88.8 years for girls</li><li>Net migration (from 2021)<br>+ 200,000 persons</li>"
	},
	fr: {
		v0: "",
		v1: "<li>Taux de fécondité<br>1,4 enfants par femme</li><li>Espérance de vie à la naissance en\xa02060<br>84,8 ans pour les hommes<br>88,8 ans pour les femmes</li><li>Solde migratoire annuel (à\xa0partir\xa0de\xa02021)<br>+ 100.000 personnes</li>",
		v2: "<li>Taux de fécondité<br>1,4 enfants par femme</li><li>Espérance de vie à la naissance en\xa02060<br>84,8 ans pour les hommes<br>88,8 ans pour les femmes</li><li>Solde migratoire annuel (à\xa0partir\xa0de\xa02021)<br>+ 200.000 personnes</li>",
		v3: "<li>Taux de fécondité<br>1,4 enfants par femme</li><li>Espérance de vie à la naissance en\xa02060<br>86,7 ans pour les hommes<br>90,4 ans pour les femmes</li><li>Solde migratoire annuel (à\xa0partir\xa0de\xa02021)<br>+ 100.000 personnes</li>",			
		v6: "<li>Taux de fécondité<br>1,6 enfants par femme</li><li>Espérance de vie à la naissance en\xa02060<br>84,8 ans pour les hommes<br>88,8 ans pour les femmes</li><li>Solde migratoire annuel (à\xa0partir\xa0de\xa02021)<br>+ 200.000 personnes</li>"
	},
	es: {
		v0: "",
		v1: "<li>natalidad<br>1,4 hijos/as por mujer</li><li>esperanza de vida en el momento de nacimiento 2060<br>84,8 años para niños<br>88,8 años para niñas</li><li>saldo migratorio (desde 2021)<br>+ 100.000 Personas</li>",		
		v2: "<li>natalidad<br>1,4 hijos/as por mujer</li><li>esperanza de vida en el momento de nacimiento 2060<br>84,8 años para niños<br>88,8 años para niñas</li><li>saldo migratorio (desde 2021)<br>+ 200.000 Personas</li>",
		v3: "<li>natalidad<br>1,4 hijos/as por mujer</li><li>esperanza de vida en el momento de nacimiento 2060<br>86,7 años para niños<br>90,4 años para niñas</li><li>saldo migratorio (desde 2021)<br>+ 100.000 Personas</li>",			
		v6: "<li>natalidad<br>1,6 hijos/as por mujer</li><li>esperanza de vida en el momento de nacimiento 2060<br>84,8 años para niños<br>88,8 años para niñas</li><li>saldo migratorio (desde 2021)<br>+ 200.000 Personas</li>"
	},
	ru: {
		v0: "",
		v1: "<li>Коэффициент суммарной рождаемости:<br>1,4 детей на женщину</li><li>Ожидаемая продолжительность жизни в 2060 г.:<br>84,8 года для мальчиков<br>88,8 года для девочек</li><li>Сальдо миграции (с 2021 г.):<br>+ 100 000 человек в год</li>",
		v2: "<li>Коэффициент суммарной рождаемости:<br>1,4 детей на женщину</li><li>Ожидаемая продолжительность жизни в 2060 г.:<br>84,8 года для мальчиков<br>88,8 года для девочек</li><li>Сальдо миграции (с 2021 г.):<br>+ 200 000 человек в год</li>",
		v3: "<li>Коэффициент суммарной рождаемости:<br>1,4 детей на женщину</li><li>Ожидаемая продолжительность жизни в 2060 г.:<br>86,7 года для мальчиков<br>90,4 года для девочек</li><li>Сальдо миграции (с 2021 г.):<br>+ 100 000 человек в год</li>",			
		v6: "<li>Коэффициент суммарной рождаемости:<br>1,6 детей на женщину</li><li>Ожидаемая продолжительность жизни в 2060 г.:<br>84,8 года для мальчиков<br>88,8 года для девочек</li><li>Сальдо миграции (с 2021 г.):<br>+ 200 000 человек в год</li>"
	}
}


// lables in the table
var tAge = {
	de: "Alter",
	en: "Age",
	fr: "Age",
	es: "Edad",
	ru: "возраст"
}

var tMill = {
	de: "Millionen",
	en: "Mill.",
	fr: "millions",
	es: "Mill.",
	ru: "млн."	
}

var tRatio = {
	de: "Anteil",
	en: "Pct.",
	fr: "Pourcent",
	es: "Proporción",
	ru: "доля"
}

var tTotal = {
	de: "Insgesamt",
	en: "Total",
	fr: "Total",
	es: "Total",
	ru: "Всего"	
}


var oldAgeDepRatio = {
	de: "Altenquotient",
	en: "Old-age dependency ratio",
	fr: "Taux de dépendance des personnes agées",
	es: "Tasa de dependencia de mayores",
	ru: "число лиц пенсионного возраста на 100 работоспособных"
}

var medianAge = {
	de: "Medianalter",
	en: "Median age",
	fr: "Age médian",
	es: "Edad (mediana)",
	ru: "медианный возраст"
}


var ageGroups = {
	de: "Altersgruppen",
	en: "Age-groups",
	fr: "Groupes d'âges",
	es: "Grupos de edad",
	ru: "Возрастные группы"
}

// this is text on a button, keep short
var switchAgeGroupsON = {
	de: "verschieben",
	en: "change",
	fr: "décaler",
	es: "desplazar",
	ru: "изменить"
}

var switchAgeGroupsOFF = {
	de: "nicht einfärben",
	en: "not painted",
	fr: "couleur uniforme",
	es: "sin color",
	ru: "не окрашивать"
}

// this is for mouseover the pyramid, highlight birthyear
var bYearTxt = {
	de: "Jahrgang",
	en: "Year of birth",
	fr: "Année de naissance",
	es: "Año de nacimiento",
	ru: "Год рождения"	
}

var persTxt = {
	de: "Personen",
	en: "people",
	fr: "Personnes",
	es: "Personas",
	ru: "человек"	
}

var embedLink = {
	de: "Diese Grafik einbetten",
	en: "Embed this graphic",
	fr: "Integrer le graphique",
	es: "Integrar el gráfico",
	ru: "Чтобы интегрировать график в Ваш сайт"
}

var embedInfo = {
	de: "Um diese Grafik in Ihre Webseite einzubinden, kopieren Sie den folgenden Programmcode",
	en: "Copy the following code to embed this graphic in your website",
	fr: "Copier le code ci-joint pour integrer le graphique dans votre site internet",
	es: "Para integrar el gráfico en su Página Web, copie el siguiente código",
	ru: "Чтобы интегрировать график в Ваш сайт, скопируйте программный код"
}

var furtherInfo = {
	de: "Weitere Informationen",
	en: "Further information",
	fr: "Informations complémentaires",
	es: "Mas informaciones",
	ru: "Читать далее"
}

var downloadInfo = {
	de: "Download der Daten",
	en: "Download the data",
	fr: "Décharger les données",
	es: "Descargar la información",
	ru: "Загрузить файл данных"
}



var de = d3.locale({
  decimal: ",",
  thousands: "\xa0",
  grouping: [3],
  currency: ["", " €"],
  dateTime: "%A, der %e. %B %Y, %X",
  date: "%e.%m.%Y",
  time: "%H:%M:%S",
  periods: ["AM", "PM"], // unused
  days: ["Sonntag", "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag"],
  shortDays: ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"],
  months: ["Januar", "Februar", "März", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"],
  shortMonths: ["Jan", "Feb", "Mrz", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"]
});

var en = d3.locale({
  decimal: ".",
  thousands: ",",
  grouping: [3],
  currency: ["£", ""],
  dateTime: "%a %e %b %X %Y",
  date: "%d/%m/%Y",
  time: "%H:%M:%S",
  periods: ["AM", "PM"],
  days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
  shortDays: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
  months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
  shortMonths: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]
});

var fr = d3.locale({
  decimal: ",",
  thousands: ".",
  grouping: [3],
  currency: ["", " €"],
  dateTime: "%A, le %e %B %Y, %X",
  date: "%d/%m/%Y",
  time: "%H:%M:%S",
  periods: ["AM", "PM"], // unused
  days: ["dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi"],
  shortDays: ["dim.", "lun.", "mar.", "mer.", "jeu.", "ven.", "sam."],
  months: ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"],
  shortMonths: ["janv.", "févr.", "mars", "avr.", "mai", "juin", "juil.", "août", "sept.", "oct.", "nov.", "déc."]
});



//
// SETTINGS 
//
var   currVariant = "v1", // must have data for intial year, applies only for years >= beginprojection
	  tmpVariant = "v1",  // switches to "v0" in past years for easier dataset structure
  	  age1 = 99,   // highest age
  	  // BEWARE HARDCODED DATE RANGE
      year0 = 1950, // earliest year
      year1 = 2060, // end year
	  beginProjection = 2014;
      year  = 2014, // initial year
      ageLimits = [20, 65],
	  speed = 700,
	  language = "de",
	  nrXticks = 7,  // number of ticks at x-axis
	  nrYticks = 5; // year increment on y-axis (age)

	  
// changes the layout programmatically for embeding and responsiveness
function reformat(size) {
	
	// size "medium/mobile" for embeding and phones
	if (size == "m") {
		
		d3.selectAll(".xl").style("display", "none");
		d3.selectAll(".birthyear").select("text").style("fill", "none");
		
		nrXticks = 3;
		nrYticks = 10;
		
		margin.right = 10, margin.left = 10;
		centerPadding = 24;
	    width = 240 - margin.left - margin.right,
		height = 480 - margin.top - margin.bottom;
		barHeight = Math.floor(height / 100);	// 100 agebands
		
		d3.select("#wrapper")
			.style("width", "512px")
			.style("height", "750px");

		d3.select("#pageHeader")
			.style("width", "494px")
			.style("height", "40px")
			.style("top", "16px")
			.style("padding-left", "16px");

		d3.select("#pageHeader h1")
			.style("margin-top", "3px")
			.style("font-size", "16px")
			.style("width", "310px")
			.style("padding-top", "0px");

		d3.select("#pageHeader img")
			.style("width", "149px")
			.style("height", "37px")
			.style("right", "5px");

		d3.select("#easel")
			.style("width", "505px")
			.style("height", "480px")
			.style("top", "78px");

		d3.select("#dashBoard")
			.style("width", "505px")
			.style("height", "145px")
			.style("left", "0px")
			.style("top", "565px");

		d3.select("#assumptions")
			.style("top", "0px")
			.style("width", "240px")
			.style("left", "20px");

		d3.select("#asmpH4")
			.style("margin-bottom", "4px");

		d3.select("#assumptions ul")
			.style("padding-left", "16px");

		d3.select("#data")
			.style("left", "278px")
			.style("top", "8px");

		d3.selectAll("td")
			.style("padding-bottom", "3px")
			.style("padding-top", "4px");
			
		d3.selectAll(".ageLimitTxt")
			.style("border-right-width", "4px");

		d3.select("#tAge")
			.style("width", "64px");
		d3.select("#tMill")
			.style("width", "70px");
		d3.select("#tRatio")
			.style("width", "70px");
			
		d3.selectAll(".age")
			.style("font-size", "14px");

		d3.selectAll(".tick text")
			.style("font-size", "14px");
	
		d3.select("#copyright")
			.style("width", "512px")
			.style("top", "735px");

		currSize = "m";
//		should expand to full size if possible even if sent from mobile
// 		state.size.val = "m";
	}

// 	rewriteHash();		
	
}

	  
// read settings from URL parameters
var readHash = function() {

	var myH =location.hash.split('#')[1];
	// keep out the script kiddies, hopefully
	if (myH) {
		var myHa = myH.substring(0, 48);
		var myHash = myHa.replace(/[^0-9a-y,&=]/g, ''); // these characters are allowed

		// many thanks to 
		// http://stackoverflow.com/questions/18346710/create-object-from-string-in-javascript
		
		var params = function(){
			var result = {};
			myHash.split(/&/).forEach(function(el){
				var parts = el.split(/=/);
				result[parts[0]] = parts[1];
				});
			return result;
		}();
		
		if (params.hasOwnProperty('a')) {
		
			var a = params.a.split(',');
			var a0 = +a[0];
			var a1 = +a[1];
			if (a0<a1 && a0>0 && a1<100) {
				ageLimits[0] = a0;
				ageLimits[1] = a1;
				state.agelimits.val=params.a;
			} 
		}

		if (params.hasOwnProperty('v')) {
		
			var v = +params.v;
			if (v>=1 && v<=6) {
									
					tmpVariant = "v"+v;
					year<beginProjection ? currVariant="v1" : currVariant=tmpVariant;
			} 
		}

		if (params.hasOwnProperty('g')) {
		
			ageState=true;
		}

		if (params.hasOwnProperty('b')) {
		
			var b = +params.b;
			if (b>=year0-100 && b<=year1) {
				clickBirthYear = b;
			} 
		}
			
		if (params.hasOwnProperty('l')) {
			// Language, Localization
			var supportedLanguages = ["de","en","fr","es","ru"];
			
				if (supportedLanguages.indexOf(params.l) > -1) {
					
					language = params.l;
					
					} else {
						
					language = "de";
						
					}

				state.language.val = language;			
			}
					
		if (params.hasOwnProperty('o')) {
			// Outline
			var o = params.o.split("v");
			
			if (+o[0]>=year0 && +o[0]<=year1) {
			
				initialOutline = true;
				ioYear = +o[0];
				
				if (+o[1]>=0 && +o[1]<=6) {
					
					ioVariant = "v"+o[1];
					
				}
			}
		}

		if (params.hasOwnProperty('s')) {
			// Layout size
			reformat(params.s);
			}
			
		if (params.hasOwnProperty('y')) {
		
			var y = +params.y;
			if (y>=year0 && y<=year1) {
				year = y;
				state.year.val = year;
			} 
		}
	
	}  // end if url has hash

	if (!state.language.hasOwnProperty('val')) {
					
		try {
			if (navigator.language.substring(0, 2)=='en') {language = "en"};
			if (navigator.language.substring(0, 2)=='de') {language = "de"};
			if (navigator.language.substring(0, 2)=='es') {language = "es"};
			if (navigator.language.substring(0, 2)=='ru') {language = "ru"};
			if (navigator.language.substring(0, 2)=='fr') {language = "fr"};
		} catch(e) {
			language = "de";
		}
	}
		
	// AUTO RESIZE to mobile view on small windows
	if (window.innerWidth < 701) { 
		
			reformat("m")
		
		}

	// initiate some localized texts
	d3.select("#ageGroupsTxt").text(ageGroups[language]);
	d3.select("#variantNick").text(Variant[language]);
	d3.select("#v1name").text(v1name[language]);
	d3.select("#v2name").text(v2name[language]);
	d3.select("#v3name").text(v3name[language]);
	d3.select("#v6name").text(v6name[language]);
	d3.select("#furtherInfo").text(furtherInfo[language]);
	d3.select("#downloadInfo").text(downloadInfo[language]);
	d3.select("#embedLink").text(embedLink[language]);
	// table labels
	d3.select("#tAge").text(tAge[language]);
	d3.select("#tMill").text(tMill[language]);
	d3.select("#tRatio").text(tRatio[language]);
	d3.select("#tTotal").text(tTotal[language]);
	// these are button labels
  	document.getElementById("ageLimiter").childNodes[0].nodeValue=switchAgeGroupsON[language];
  	document.getElementById("makeOutline").childNodes[0].nodeValue=makeOutlineVerb[language];
  	// localized numberFormats
  	if (language == "de" || language == "ru") { locale = de; }	
  	if (language == "fr" || language == "es") { locale = fr; }	
  	if (language == "en") { locale = en; }	

} // end readHash function

readHash();


/* numberformats */
var mill = locale.numberFormat(".1f");
var perc = locale.numberFormat("%");
var thsd = locale.numberFormat("n");
var full = d3.format("0f");


var yearSlider = d3.slider().value(year).orientation("vertical")
				.min(year0).max(year1).step(1)
				.axis( d3.svg.axis().orient("right")
					.tickValues([1950,1960,1970,1980,1990,2000,2014,2030,2040,2050,2060])
					.tickPadding(10) 
					.tickFormat(d3.format(""))
					)
				.on("slide", function(evt, value) {
					evt.stopPropagation();
					scrollPyramid(value, currVariant);
    				});

d3.select('#sliderHolder').call(yearSlider);

d3.select("#txLow").text("<"+ageLimits[0]);
d3.select("#txMed").text(ageLimits[0]+"–"+(ageLimits[1]-1));
d3.select("#txUp").text(ageLimits[1]+"+");



//
// SCALES
//
var x = d3.scale.linear()
    .range([width, 0]);
    
var w = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.linear()
	//.ordinal()
	//.rangeRoundBands([barHeight / 2, height - barHeight / 2]);
    .range([barHeight / 2, height - barHeight / 2]);

// y scale for the path outline 
var yy = d3.scale.linear()
    .range([-barHeight, -height])
    .domain([0, age1]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .ticks(nrXticks)
    .tickSize(-height)
    .tickPadding(7);

var wAxis = d3.svg.axis()
    .scale(w)
    .orient("bottom")
    .ticks(nrXticks)
    .tickSize(-height)
    .tickPadding(7);


    
// An SVG element with a bottom-right origin
var svg = d3.select("#easel").append("svg")
    .attr("width", (width + margin.left + margin.right)*2+centerPadding)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    	
// A sliding container to hold the bars by birthyear.
var birthyears = svg.append("g")
    .attr("class", "birthyears");

var dsv = d3.dsv(";", "text/plain");

dsv("data/bev13te_v1236.csv",function(csv) {

  datacsv=d3.nest()
    .key(function(d) {return d.Simulationsjahr;})
    .key(function(d) {return d.mw;})
    .key(function(d) {return d.Variante;})
    .map(csv);

    // shuffle the destatis table into the mbostock example format
    for (i=year0; i<(year1+1); i++) {
    
 		if (typeof datacsv[i].m[0] != "undefined") {

        for (j=0; j<(age1+1); j++) {
			// observed data of the past
           data.push({year: +i, age: +j, mw: "1", variant: "v0", people : +datacsv[i].m[0][0]["Bev_"+j+"_"+(j+1)]});
           data.push({year: +i, age: +j, mw: "2", variant: "v0", people : +datacsv[i].w[0][0]["Bev_"+j+"_"+(j+1)]});

           } 
		}
		           
 		if (typeof datacsv[i].m[1] != "undefined") {
 		
        for (j=0; j<(age1+1); j++) {
			// several projection variants
           data.push({year: +i, age: +j, mw: "1", variant: "v1", people : +datacsv[i].m[1][0]["Bev_"+j+"_"+(j+1)]});
           data.push({year: +i, age: +j, mw: "2", variant: "v1", people : +datacsv[i].w[1][0]["Bev_"+j+"_"+(j+1)]});
           data.push({year: +i, age: +j, mw: "1", variant: "v2", people : +datacsv[i].m[2][0]["Bev_"+j+"_"+(j+1)]});
           data.push({year: +i, age: +j, mw: "2", variant: "v2", people : +datacsv[i].w[2][0]["Bev_"+j+"_"+(j+1)]});
           data.push({year: +i, age: +j, mw: "1", variant: "v3", people : +datacsv[i].m[3][0]["Bev_"+j+"_"+(j+1)]});
           data.push({year: +i, age: +j, mw: "2", variant: "v3", people : +datacsv[i].w[3][0]["Bev_"+j+"_"+(j+1)]});
           data.push({year: +i, age: +j, mw: "1", variant: "v6", people : +datacsv[i].m[6][0]["Bev_"+j+"_"+(j+1)]});
           data.push({year: +i, age: +j, mw: "2", variant: "v6", people : +datacsv[i].w[6][0]["Bev_"+j+"_"+(j+1)]});
           }
        }
    }

  // Update the scale domains.
  var maxPeople = d3.max(data, function(d) { return d.people; })
  x.domain([0, maxPeople]);
  w.domain([0, maxPeople]);
  y.domain([year1 - age1, year1]);


// agegroup slider will be attached to a Div that fits the pyramid
// beware SVG coordinates now used in HTML
var ageSliderDiv = d3.select("#easel").append("div")
			.attr("id", "ageSliderHolder")
			.style("height", height+"px")
			.style("top", margin.top-3+"px") // offset slider handle 
			.style("left", margin.left+centerPadding/2+width+"px");

var labelHandle1 = ageSliderDiv.append("div")
			.attr("class", "ageLimit")
			.style("top", y(year1 - ageLimits[0])-2+"px") // manual offset also ageSlider
			.text(ageLimits[0]);

var labelHandle2 = ageSliderDiv.append("div").attr("class", "ageLimit")
			.attr("class", "ageLimit")
			.style("top", y(year1 - ageLimits[1])-2+"px") // manual offset also ageSlider
			.text(ageLimits[1]);

var ageGroupSlider = d3.slider().value(ageLimits).orientation("vertical")
				.min(0).max(100).step(1)
				.animate(false)
				.on("slide", function(evt, value) {
					// what gets done when the age limit handles are draged
					ageLimits = value;
					state.agelimits.val = ageLimits[0] + "," + ageLimits[1];
					rewriteHash();
					d3.select("#txLow").text("<"+ageLimits[0]);
					d3.select("#txMed").text(ageLimits[0]+"–"+(ageLimits[1]-1));
					d3.select("#txUp").text(ageLimits[1]+"+");
					labelHandle1
						.style("top", y(year1 - ageLimits[0])-2+"px") // manual offset see above
						.text(ageLimits[0]);
					labelHandle2
						.style("top", y(year1 - ageLimits[1])-2+"px") // manual offset see above
						.text(ageLimits[1]);
					paintAgeGroups();
					calcAgegroups();
   				});

d3.select('#ageSliderHolder').call(ageGroupSlider);


  // move the sliding container to initial position if not end year
  birthyears.attr("transform", "translate(0," + (y(year1) - y(year)) + ")");
  
  // Produce a map from year and birthyear to [male, female].
  data = d3.nest()
      .key(function(d) { return d.year; })
      .key(function(d) { return d.variant; })
      .key(function(d) { return d.year - d.age; })
      .rollup(function(v) { return v.map(function(d) { return d.people; }); })
      .map(data);
      
  // Add an axis to show the population values.
  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis)
      .append("text")       
      	.attr("x", width/2 )
        .attr("y",  32 )
        .attr("class", "xAxisLabel")
        .text(xMen[language]);

  // Add a *** 2nd axis *** to show the population values of women to the right.
  svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate("+(width+centerPadding)+"," + height + ")")
      .call(wAxis)
      .append("text")       
      	.attr("x", width/2 )
        .attr("y",  32 )
        .attr("class", "xAxisLabel")
        .text(xWomen[language]);

 
   // A label for the current year.
  title = svg.append("text")
   	.attr("class", "title")
   	.attr("x", 90)
   	.attr("y", 35)
   	.text(year);
   	
  var subTitle  = svg.append("text")
   	.attr("class", "subtitle")
   	.attr("x", 90)
   	.attr("y", 0)
   	.text(ageStructure[language]);

 
 	pastFuture();

 
 
  // Add labeled rects for each birthyear (so that no enter or exit is required).
  birthyear = birthyears.selectAll(".birthyear")
      .data(d3.range(year0 - age1, year1 + 1, 1))	// 1yr agebands for every year
    .enter().append("g")
      .attr("class", function(birthyear) { return birthyear==clickBirthYear ? "clickBirthYear" : "birthyear" }) // in case highlight birthyears was invoked by URL
      .attr("transform", function(birthyear) { return "translate(0," + y(birthyear) + ")"; })
      .on("mouseover", function(d) { 
	      if (clickBirthYear==0) {
      			d3.select(this).select("text").style("opacity", 0)
      			// no highlight of the symmetry
      			d3.select(this).select(".males").style("fill", highlight)
      			d3.select(this).select(".females").style("fill", highlight)
      			d3.select(this).append("text")
      						.attr("class", "hoverBirthYear")
      						.attr("x", width-10)
      						.attr("y", -1)
      						.attr("text-anchor", "end")
  							.text(bYearTxt[language]+" "+d);
      			d3.select(this).append("text")
      						.attr("class", "hoverBirthYear hoverTotals")
      						.attr("x", width+centerPadding+10)
      						.attr("y", -1)
      						.attr("text-anchor", "start")
  							.text(thsd((data[year][tmpVariant][d][0]+data[year][tmpVariant][d][1])*1000)+" "+persTxt[language]);
  				}
      		})
      .on("click", function(d) {
	      if (clickBirthYear==0) {	      
	      		clickBirthYear = d;
	      		state.birthyear.val = clickBirthYear;
	      		rewriteHash();
      			d3.select(this).attr("class", "clickBirthYear")
      			}
	      })
      .on("mouseout", function(d, i) { 
        	if (clickBirthYear==0) { 	
        		d3.select(this).select(".males").style("fill", tmpMcolor);
        		d3.select(this).select(".females").style("fill", tmpFcolor);
      			d3.select(this).select("text").style("opacity", 1);
	  			d3.select(this).selectAll(".hoverBirthYear").remove(); 
	  			}
      		});
      
  birthyear.selectAll("rect")
     .data(function(birthyear) { 
     	     	var mf = !data[year][tmpVariant][birthyear] ? [0, 0] : data[year][tmpVariant][birthyear];
     	     	var sym = d3.min(mf);
     		return [mf[0], mf[1], sym, sym];	// pyramid and symmetry
     })
    .enter().append("rect")
      .attr("y", -barHeight / 2)
      .attr("height", barHeight)
      .attr("class", function(d, i){
      		if (i==0) {return "males"}
      		if (i==1) {return "females"}
      		if (i>1) {return "symmetry"}
      })
      .style("fill", function(d, i){		// in case initial year is in the past
      		if (i==0) {return tmpMcolor}
      		if (i==1) {return tmpFcolor}
      })
      .attr("x", function(d, i){
      		return i % 2 ? width+centerPadding : x(d)})
      .attr("width", function(d, i){
      		return i % 2 ? w(d) : width - x(d)});
      
  // Add labels to show birthyear.
  birthyear.append("text")
      .attr("x", width - 20)
      .attr("dy", ".35em")
      .text(function(birthyear, i) { return (i+6) % 5 ? "" : birthyear }); // +6 by trial & error
      
  // Add labels to show age (separate; not animated).
  svg.selectAll(".age")
      .data(d3.range(0, age1 + 2, nrYticks))	// 5year label up to 100 (+2 ?)
    .enter().append("text")
      .attr("class", "age")
      .attr("y", function(age) { return y(year1 - age); }) // may be an issue with the original: year1 instead of year
      .attr("x", width + centerPadding/2)
      .attr("dy", ".3em")
      .text(function(age) { return age; });
	  
  	// draw Play/Pause UI on top of scales
  	// Icons from the material design project
    // https://github.com/google/material-design-icons
    var pause = "M18 32h4V16h-4v16zm6-28C12.95 4 4 12.95 4 24s8.95 20 20 20 20-8.95 20-20S35.05 4 24 4zm0 36c-8.82 0-16-7.18-16-16S15.18 8 24 8s16 7.18 16 16-7.18 16-16 16zm2-8h4V16h-4v16z";
    var play = "M20 33l12-9-12-9v18zm4-29C12.95 4 4 12.95 4 24s8.95 20 20 20 20-8.95 20-20S35.05 4 24 4zm0 36c-8.82 0-16-7.18-16-16S15.18 8 24 8s16 7.18 16 16-7.18 16-16 16z";
    
    uiHolder = svg.append("g")
    				.attr("transform", "translate("+ (2*width+5) +", "+ (height-56) +")")
    				.attr("class", "noPrint")
    				.style("fill", "#999");
    
    uiHolder.append("path")
    	.attr("d", pause)
    	.attr("id", "pause")
    	.style("opacity", 0);
   
    uiHolder.append("path")
    	.attr("d", play)
    	.attr("id", "play");
    	
    uiHolder.append("path")
    	.attr("d", "M0 0h48v48H0z")
    	.style("opacity", 0)
    	.on("click", toggleAnimate);

  // Allow the arrow keys to change the displayed year.
  window.focus();
  d3.select(window).on("keydown", function() {
    switch (d3.event.keyCode) {
      case 37: year = Math.max(year0, year - 1); break;
      case 39: year = Math.min(year1, year + 1); break;
    }
    pyramid(year);
  });


// set radio buttons
d3.select("#"+currVariant).attr("checked", true);

	// changeVariantText(currVariant);
	// first time without transition so that adapted li-styles can take effect
	d3.select("#assumptionsHead").text(Assumptions[language]);
	d3.select("#assumptionsHeadx").text(shortVariant[currVariant]);

	d3.select("#assumptionList").html(assumptionDetails[language][currVariant]);

	if (currSize=="m") {
		
		d3.selectAll("#assumptionList li")
			.style("padding-bottom", "3px")
			.style("line-height", "120%");
	}

calcAgegroups();


// in case some settings were invoked by URL parameters
if (currSize=="m") {

	d3.selectAll(".birthyear")
		.style("fill", "none");

	d3.selectAll(".age")
		.style("font-size", "14px");

	d3.selectAll(".tick text")
		.style("font-size", "12px");

	d3.selectAll(".xAxisLabel")
		.style("font-size", "12px");
}

if (ageState) {
	ageState=false;
	firstRun=true;
	toggleAgeLimits();
	}

if (clickBirthYear!=0) {

 	d3.select(".clickBirthYear").select(".males").style("fill", highlight);
 	d3.select(".clickBirthYear").select(".females").style("fill", highlight);

	d3.select(".clickBirthYear").append("text")
				.attr("class", "hoverBirthYear")
				.attr("x", width-10)
				.attr("y", -1)
				.attr("text-anchor", "end")
				.text(bYearTxt[language]+" "+clickBirthYear);
	d3.select(".clickBirthYear").append("text")
				.attr("class", "hoverBirthYear hoverTotals")
				.attr("x", width+centerPadding+10)
				.attr("y", -1)
				.attr("text-anchor", "start")
				.text(thsd((data[year][tmpVariant][clickBirthYear][0]+data[year][tmpVariant][clickBirthYear][1])*1000)+" "+persTxt[language]);
	}
	
if (initialOutline) { outline(ioYear, ioVariant) }

// TESTING SCREEN SIZE DETECTION
// title.text(document.documentElement.clientWidth);
// title.text(window.innerWidth);

// remove loading indicator 
d3.selectAll(".hourglass").remove();

}); // end of stuff that gets done after loading the csv data



// Mousewheel Scrolling thanks to
// http://blog.paranoidferret.com/index.php/2007/10/31/javascript-tutorial-the-scroll-wheel/

function hookEvent(element, eventName, callback)
{
  if(typeof(element) == "string")
    element = document.getElementById(element);
  if(element == null)
    return;
  if(element.addEventListener)
  {
    if(eventName == 'mousewheel')
    {
      element.addEventListener('DOMMouseScroll', 
        callback, false);  
    }
    element.addEventListener(eventName, callback, false);
  }
  else if(element.attachEvent)
    element.attachEvent("on" + eventName, callback);
}

function MouseWheel(e)
{
  e.preventDefault();
  e.stopPropagation();
  e = e ? e : window.event;
  var wheelData = e.detail ? e.detail * -1 : e.wheelDelta;
  wheelData > 0 ? year = Math.max(year0, year - 1) : year = Math.min(year1, year + 1);
  scrollPyramid(year, currVariant);
}


// tries to emulate the mousewheel behaviour on swipe in y-axis

touchStart = function(event) {
		startY = event.touches[0].pageY;
		keepTrackOfTouches = event.touches.length;
	}

touchEnd = function(event) {
		keepTrackOfTouches = event.touches.length;
	}

touchMove = function(event) {
	// Prevent scrolling on the pyramd div
	event.preventDefault();
	
	// do the following only when x fingers are touching simultanously
	if (keepTrackOfTouches == 1) {
		
		var y = startY - event.touches[0].pageY;
		y < 0 ? year = Math.max(year0, year - 1) : year = Math.min(year1, year + 1);
		scrollPyramid(year, currVariant);
	}
}


// some handdrawn circles around the agesliders for attention grabbing
// path animation thanks to http://bl.ocks.org/duopixel/4063326
//
var baseSVG = d3.select("#easel").select("svg").append("g");

var upperPathG = baseSVG.append("g").attr("transform", "translate(0 -280)");

var handDrawn="M381.277,493.511 C397.462,493.562 414.705,487.692 433.728,497.935 C444.402,503.682 442.406,514.239 429.874,521.472 C412.179,531.684 374.481,534.336 345.445,532.824 C336.632,532.365 287.429,527.906 273.59,519.24 C233.753,494.294 353.741,480.883 387.859,489.221";

var upperPath = upperPathG
			.append("path")
			.attr("d", handDrawn)
			.attr("class", "swoosh noPrint");

var totalLength = upperPath.node().getTotalLength(); // prevent little blobbs in ff

var lowerPath = baseSVG.append("path")
			.attr("d", handDrawn)
			.attr("class", "swoosh noPrint");
			
upperPath
      .attr("stroke-dasharray", totalLength + " " + totalLength)
      .attr("stroke-dashoffset", totalLength);
lowerPath
      .attr("stroke-dasharray", totalLength + " " + totalLength)
      .attr("stroke-dashoffset", totalLength);

function drawCircles(){
      upperPath      
        .transition()
        .delay(150)
        .duration(400)
        .ease("linear")
        .attr("stroke-dashoffset", 0);
      lowerPath      
        .transition()
        .delay(600)
        .duration(400)
        .ease("linear")
        .attr("stroke-dashoffset", 0);
      firstRun = true;
}


function removeCircles() {
	if (firstRun) { d3.selectAll(".swoosh").remove(); }
}


function toggleAgeLimits() {
	
	resetClicked();
  	ageState = !ageState;

  	if (ageState) {
	  	
	  	birthyears.attr("pointer-events", "none");
	  	d3.select("#ageSliderHolder").style("display", "block");
	  	d3.selectAll(".age").style("fill", "#aaa");
	  	document.getElementById("ageLimiter").childNodes[0].nodeValue=switchAgeGroupsOFF[language];
	  	paintAgeGroups();
		d3.select("#txUp").style( "border-right-color", "#ffc283");
		d3.select("#txMed").style("border-right-color", "#68a96d");
		d3.select("#txLow").style("border-right-color", "#abaaab");
		if (!firstRun) { drawCircles(); }
		state.agegroups.val = true;
		rewriteHash();

  	} else {

		d3.select("#txLow").style("border-right-color", "#fff");
		d3.select("#txMed").style("border-right-color", "#fff");
		d3.select("#txUp").style( "border-right-color", "#fff");
	  	birthyears.attr("pointer-events", "all");
	  	d3.select("#ageSliderHolder").style("display", "none");
	  	d3.selectAll(".age").style("fill", "#444");
	  	document.getElementById("ageLimiter").childNodes[0].nodeValue=switchAgeGroupsON[language];
	    d3.selectAll(".males").style("fill", tmpMcolor);
	    d3.selectAll(".females").style("fill", tmpFcolor);
	    removeCircles();
		state.agegroups.val = false;
		rewriteHash();
  	}
}


function paintAgeGroups() {

	var filterOld = birthyear.filter(function(d) { 
		return d <= (year - ageLimits[1])
		});
	var filterMed = birthyear.filter(function(d) { 
		return d <= (year - ageLimits[0]) && d > (year - ageLimits[1])
		});
	var filterYng = birthyear.filter(function(d) { 
		return d > (year - ageLimits[0])
		});

	filterOld.selectAll(".males").style("fill", oldColor);
	filterOld.selectAll(".females").style("fill", oldColor);
	filterMed.selectAll(".males").style("fill", mediumColor);
	filterMed.selectAll(".females").style("fill", mediumColor);
	filterYng.selectAll(".males").style("fill", youngColor);
	filterYng.selectAll(".females").style("fill", youngColor);
}


function calcAgegroups() {
	
	year < beginProjection ? tmpVariant = "v0" : tmpVariant = currVariant;

	var young = 0;
	var medium = 0;
	var old = 0;

	for (var i=0;i<ageLimits[0];i++)	{
		young += data[year][tmpVariant][year-i][0] + data[year][tmpVariant][year-i][1];
	}
	for (var j=ageLimits[0];j<ageLimits[1];j++)	{
		medium += data[year][tmpVariant][year-j][0] + data[year][tmpVariant][year-j][1];
	}

	// Total Pop incl. 100+ AGE GROUP (males and females)
	var tmpVariantInt = +tmpVariant.split("v")[1];
	var sum = +datacsv[year].m[tmpVariantInt][0].Bev + ( datacsv[year].w[tmpVariantInt][0].Bev -0);

	old = sum - medium - young;

	var OldPercMed = old/medium*100;
	
	d3.select("#youngAbs").text(mill(young/1000));
	d3.select("#mediumAbs").text(mill(medium/1000));
	d3.select("#oldAbs").text(mill(old/1000));
	d3.select("#totals").text(mill(sum/1000));

	d3.select("#altQ").text(medianAge[language]+" "+mill(datacsv[year].m[tmpVariantInt][0].Median)+"\xa0 \xa0 | \xa0 \xa0"+oldAgeDepRatio[language]+"\xa0"+full(OldPercMed));

	d3.select("#youngPerc").text(perc(young/sum));
	d3.select("#mediumPerc").text(perc(medium/sum));
	d3.select("#oldPerc").text(perc(old/sum));

}


// reset clicked birthYear 
function resetClicked() {
	
 	d3.selectAll(".hoverBirthYear").remove();
 	d3.select(".clickBirthYear").select(".males").style("fill", tmpMcolor);
 	d3.select(".clickBirthYear").select(".females").style("fill", tmpFcolor);
 	d3.select(".clickBirthYear").select("text").style("opacity", 1);
 	d3.select(".clickBirthYear").attr("class", "birthyear");
 	clickBirthYear = 0;	
 	state.birthyear.val = clickBirthYear;
 	rewriteHash();
}


// this will move a clicked birthyear along
// via animation, slider, scrollwheel, touch or keyboard
// until it reaches either end of the pyramid (top or bottom)
function movingBirthYear() {
		
	if (clickBirthYear == 0) { 
 	
 		// since mouseout is not triggered during animated pyramid
	 	d3.selectAll(".hoverBirthYear").remove() 
 	
 	} else {
 	
 	if ((year-clickBirthYear)< 0 || (year-clickBirthYear)>99) {

 		resetClicked();
 		
 	} else {

 	 	d3.select(".clickBirthYear").select(".hoverTotals")
	 		.text(thsd((data[year][tmpVariant][clickBirthYear][0]+data[year][tmpVariant][clickBirthYear][1])*1000)+" "+persTxt[language]);
 		}
	}
}

// the past has only one variant ("v0")
// the future has usually several ("v1", "v2", "v3" …)
// color-switching of the bars is done here as well
// if necessary

// maybe reference only once for performance?
var headLine=d3.select("#headline");
var assumptionsDiv=d3.selectAll(".futureMeta");

function pastFuture() {
	
	var beforeColor=tmpMcolor;
    title.text(year);

	if (year < beginProjection) {
		headLine.text(headPast[language]);
		assumptionsDiv.style("display", "none");
	    tmpVariant = "v0"
		state.variant.val = "2";
	    tmpMcolor = pastMcolor;
	    tmpFcolor = pastFcolor;
    } else {
		headLine.text(head[language]);
		assumptionsDiv.style("display", "block");
	    tmpVariant = currVariant;	
		state.variant.val = tmpVariant.substring(1, 2);
	    tmpMcolor = futureMcolor;
	    tmpFcolor = futureFcolor;
    }
    
	// minimize repaints
    if (beforeColor!=tmpMcolor) {

	    d3.selectAll(".males").style("fill", tmpMcolor);
	    d3.selectAll(".females").style("fill", tmpFcolor);
	 	d3.select(".clickBirthYear").select(".males").style("fill", highlight)
	 	d3.select(".clickBirthYear").select(".females").style("fill", highlight)
    }
}


function pyramid(myYear) {

    year = myYear;
	yearSlider.value(year);
 	pastFuture(); 	

    birthyears
    	.transition()
    	.ease("linear")
        .duration(speed)
        .attr("transform", "translate(0," + (y(year1) - y(year)) + ")");

    birthyear.selectAll("rect")
     .data(function(birthyear) { 
     	     	var mf = !data[year][tmpVariant][birthyear] ? [0, 0] : data[year][tmpVariant][birthyear];
     	     	var sym = d3.min(mf);
     		return [mf[0], mf[1], sym, sym];	// pyramid and symmetry
     })
      .transition()
        .duration(speed)
      .attr("x", function(d, i){
      		return i % 2 ? width+centerPadding : x(d)})
      .attr("width", function(d, i){
      		return i % 2 ? w(d) : width - x(d)});
	  
	  movingBirthYear();
	  calcAgegroups();
 }


function changeVariant(myVariant) {
	
	state.variant.val = myVariant.substring(1, 2);
	rewriteHash();
		
	if (animState) { 				// during animation 
		
			currVariant=myVariant;
			stopAnimate(); 
			animState=false;
			setTimeout("scrollPyramid(year, currVariant)", speed);  // let animation of year finish, then draw stopped pyramid with myVariant
			
		} else {

			scrollPyramid(year, myVariant);
			
		}	
		
	changeVariantText(myVariant);
}


function changeVariantText(myVariant) {

	d3.select("#assumptions")
		.transition()
		.duration(300)
		.style("color", "#ccc")
		.each("end", function() {
			d3.select("#assumptionsHeadx").text(shortVariant[myVariant]);
			d3.select("#assumptionList").html(assumptionDetails[language][myVariant]);
		});
	d3.select("#assumptions")
		.transition()
		.delay(300)
		.duration(300)
		.style("color", "#000");	
}


// similar to the pyramid but without transitions
function scrollPyramid(myYear, myVariant) {

    year = myYear;
	yearSlider.value(year);
		
	currVariant = myVariant;
	pastFuture();    
	
	state.year.val=year;
	rewriteHash();

    birthyears
        .attr("transform", "translate(0," + (y(year1) - y(year)) + ")");

    birthyear.selectAll("rect")
     .data(function(birthyear) { 
     	     	var mf = !data[year][tmpVariant][birthyear] ? [0, 0] : data[year][tmpVariant][birthyear];
     	     	var sym = d3.min(mf);
     		return [mf[0], mf[1], sym, sym];	// pyramid and symmetry
     })
      .attr("x", function(d, i){
      		return i % 2 ? width+centerPadding : x(d)})
      .attr("width", function(d, i){
      		return i % 2 ? w(d) : width - x(d)});

	  movingBirthYear();
	  calcAgegroups();
	  if (ageState) {paintAgeGroups();}
}
  

var legendSvg = d3.select("#legend").append("svg")
							.attr("width", "50px")
							.attr("height", "60px")
							.on("click", function(d){
								outline(year, tmpVariant);
							});

var miniOutline = legendSvg.append("g")
  					.attr("transform", "scale(0.074)");
  					
var yearLegend = legendSvg.append("text")
							.attr("x", 24)
							.attr("y", 30)
							.attr("class", "mini Year");

var variantLegend = legendSvg.append("text")
							.attr("x", 24)
							.attr("y", 57)
							.attr("class", "mini Variant");

// toggles an outline of specified year and variant
function outline(oYear, oVariant) {
	
	fixState = !fixState;
	
	if (!fixState) {
	
		d3.selectAll(".outline").remove();
		yearLegend.text("");
		variantLegend.text("");
		d3.select("#legend").select("button").style("display", "block")
		delete state.outline.val;
		rewriteHash();
	
	} else {
	    
	  d3.select("#legend").select("button").style("display", "none")
	
	  if (oYear < beginProjection) {
	      var tempVariant = "v0";
		  state.outline.val = oYear;
	  } else {
	      var tempVariant = oVariant;	
		  state.outline.val = oYear + oVariant;
	  }

	  rewriteHash();
	   
	    femPathHolder = svg.append("g")
	    	      .attr("transform", "translate("+(width+centerPadding)+"," + height + ")")
	    	      .attr("class", "outline");
	    
	    malePathHolder = svg.append("g")
	    	      .attr("transform", "translate(0," + height + ")")
	    	      .attr("class", "outline");
	    
	    // construct path data
	    var femPath = "M " + w(data[oYear][tempVariant][oYear][1]) + " 0 L";
	    var malePath = "M " + x(data[oYear][tempVariant][oYear][0]) + " 0 L";
	    
	    for (j=0; j<(age1); j++) {
	        
	    	var	femX  = w(data[oYear][tempVariant][oYear-j][1]);
	    	var	femX1 = w(data[oYear][tempVariant][oYear-j-1][1]);
	    	var	maleX  = x(data[oYear][tempVariant][oYear-j][0]);
	    	var	maleX1 = x(data[oYear][tempVariant][oYear-j-1][0]);
	    	
	    	var	mfY = yy(j);
	    	
	    	femPath+= " "+femX+" "+mfY+" "+femX1+" "+mfY;
	    	malePath+= " "+maleX+" "+mfY+" "+maleX1+" "+mfY;
	  
	    }
	    
	    femPath+= " "+ w(data[oYear][tempVariant][oYear-age1][1]) +" "+yy(age1);
	    malePath+= " "+ x(data[oYear][tempVariant][oYear-age1][0]) +" "+yy(age1);
	    	  
	    femPathHolder.append("path")
	    		.attr("d", femPath)
	    		.attr("class", "envelopeCurve");
	    malePathHolder.append("path")
	    		.attr("d", malePath)
	    		.attr("class", "envelopeCurve");
	  
	    var femMiniHolder = miniOutline.append("g")
	    	      .attr("transform", "translate("+(width+centerPadding)+"," + height + ")")
	    	      .attr("class", "outline");
	    
	    var maleMiniHolder = miniOutline.append("g")
	    	      .attr("transform", "translate(0," + height + ")")
	    	      .attr("class", "outline");	    		
	  
	    femMiniHolder.append("path")
	    		.attr("d", femPath)
	    		.attr("class", "envelopeCurve miniCurve");
	    maleMiniHolder.append("path")
	    		.attr("d", malePath)
	    		.attr("class", "envelopeCurve miniCurve");
	    		
	    yearLegend.text(oYear);
	    variantLegend.text(shortVariant[tempVariant]);
	  }  
	}


  function nextPyramid() {
  	
		year+=1;
		if (year > year1) {
			
			stopAnimate();
			birthyears
				.transition()
				.delay(speed*3)
				.duration(1000)
				.style("opacity", 0)
				.each("end", function() {
					
						if (ageState) {paintAgeGroups();};
						scrollPyramid(year0, currVariant);
						birthyears
						.transition()
						.duration(1000)
						.style("opacity", 1)
						.each("end", function() {
								startAnimate();
							});
					});
			
		} else {
			
			if (ageState) {paintAgeGroups();}
			pyramid(year);
			
			state.year.val=year;
			rewriteHash();
					
		}
  }

  function startAnimate() {
  	
  	 animate = setInterval(nextPyramid, speed);

     uiHolder.select("#play")
     	.style("opacity", 0)
  	 uiHolder.select("#pause")
     	.style("opacity", 1)

  }
  	  
  function stopAnimate() {

     uiHolder.select("#pause")
     	.style("opacity", 0)
     uiHolder.select("#play")
     	.style("opacity", 1)
  
  	 clearInterval(animate);
  }
  
  function toggleAnimate() {
  	animState = !animState;
  	animState ? startAnimate() : stopAnimate();
  }
  

// example URL parametesr
// #!y=2049&a=17,60&v=3&o=2023v1&l=de&s=xl&g&b=1968

function rewriteHash() {

	// the "!" gets filtered out in the readHash function
	// but otherwise keeps the scrolling position of the page intact
	var myHash="!";

	for (var key in state) {
			if (state[key].hasOwnProperty('val') && state[key].val != state[key].default) {
			myHash += state[key].hsh +"="+ state[key].val +"&";
			}
		}
	// boolean values are represented with just their parameter shortname present or not
	myHash = myHash.replace(/=true/,'');
	// removes the last "&" for aesthetic reasons (end of line)
	location.hash = myHash.replace(/&$/,'');
}

function embed() {
// 	reformat('m');
	location.hash == "" ? location.hash = "#&s=m" : location.hash += "&s=m";
	var currUrl = location.origin + location.pathname + location.hash;
	var partOne = '<iframe width="512px" height="720px" src="';
	var partTwo = '" scrolling="no" frameborder="0"></iframe>';
	window.prompt(embedInfo[language], partOne+currUrl+partTwo);
}

</script>
</html>